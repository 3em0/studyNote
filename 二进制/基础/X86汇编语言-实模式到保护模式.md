# 10 å¾ªç¯ æ‰¹é‡ä¼ é€å’Œæ¡ä»¶è½¬ç§»

> å‰é¢çš„è¯¾ç¨‹åœ¨ä¹¦ä¸Šå·²ç»çœ‹è¿‡äº† å°±ä¸å¿…å¤šè¿½è¯‰äº† ä¸»è¦æ˜¯ä¹Ÿæ‡’å¾—å†çœ‹ä¸€éäº†
>
> æ¯å¤©çœ‹æ±‡ç¼– å¥åº·ä¸€æ•´å¤©

`8086`å¤„ç†å™¨ä¸Šï¼Œå¦‚æœå¯„å­˜å™¨æä¾›åç§»åœ°å€çš„è¯ï¼Œåªèƒ½ä½¿ç”¨`BX,SI,DI,BP`è¿™å››ä¸ªã€‚

`BX`: åŸºå€å¯„å­˜å™¨

`CX`: è®¡æ•°å™¨

`DX`ï¼š æ•°æ®å¯„å­˜å™¨

------

`inc r/m`     `dec r/m`

------

8086å¤„ç†å™¨ä¸­ï¼Œå‡ ç§åŸºå€å˜å€çš„ç»„åˆ

bx + si 

bx + di 

bp + si

bp + di



# 11 è®¡ç®—æœºä¸­çš„è´Ÿæ•°

> ç•¥

åœ¨ç¨‹åºä¸­ å¦‚æœè¦ä½¿ç”¨è´Ÿæ•°å°±ç›´æ¥ä½¿ç”¨è´Ÿæ•°å°±å¯ä»¥äº†ã€‚`mov dx -1`

> sub r/m, r/m/imm å·¦-å³ï¼Œå†æŠŠç»“æœæ”¾åˆ°å·¦ã€‚

ä¸¤ä¸ªæ“ä½œæ•°å¿…é¡»ä¸èƒ½åŒæ—¶ä¸ºå¯„å­˜å™¨ï¼Œè¿™ç§æƒ…å†µæ˜¯è¦æœç»çš„ã€‚

```assembly
sub byte [0x202],35
sub byte [0x202], ax
```

:red_circle:ä¸‹é¢è¿™ç§æƒ…å†µçš„byteæ˜¯å¯ä»¥çœç•¥çš„ï¼Œå› ä¸ºåœ¨å·¦è¾¹å·²ç»é™å®šäº†æ“ä½œä½æ•°ä¸º8ä½ï¼Œè€Œç¬¬ä¸€ä¸ªçš„ç«‹å³æ•°æ˜¯å¯å¤§å¯å°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»é™åˆ¶byteã€‚

```
neg r/m æ±‚è¡¥ç 
```

![image-20220223084045579](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220223084045579.png)

å¤§å¤šæ•°çš„æŒ‡ä»¤éƒ½æ˜¯å¯ä»¥é€šç”¨æœ‰ç¬¦å·å’Œæ— ç¬¦å·æ•°çš„ï¼Œä½†æ˜¯éƒ¨åˆ†æŒ‡ä»¤éœ€è¦é€‰æ‹©æœ‰ç¬¦å·ç‰ˆæœ¬å’Œç¬¦å·ç‰ˆæœ¬ã€‚

`idiv`

![image-20220223093632702](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220223093632702.png)



# é˜¶æ®µæ€»è®¡

## æ ‡å¿—ä½

![image-20220223142734572](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220223142734572.png)

å…¶ä¸­`CF`æ˜¯è¿›ä½æ ‡è¯†ç¬¦ï¼Œæœ‰è¿›ä½æ“ä½œçš„æ—¶å€™ä¼šç½®ä¸º1ï¼Œ`PF`å¥‡å¶æ ‡è¯†ç¬¦

![image-20220223142822236](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220223142822236.png)

`OF`:æº¢å‡ºæ ‡å¿—

![image-20220223143010902](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220223143010902.png)

`SF:` ç¬¦å·æ ‡å¿—

![image-20220223143520696](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220223143520696.png)

`AF`:è°ƒæ•´æ ‡å¿—

ç°æœ‰æŒ‡ä»¤å¯¹äºæ ‡å¿—ä½å½±å“

![image-20220223143700441](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220223143700441.png)

åˆ†æä»¥ä¸‹ç¬¦å·ä½çš„å˜åŒ–ï¼š

![image-20220223144513055](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220223144513055.png)

```
é¦–å…ˆ SFæ˜¯ç¬¦å·æ ‡å¿—ï¼Œåœ¨ä¸€å¼€å§‹å°±ç½®ä¸º1ï¼Œç„¶åè®¡ç®—åç»“æœçš„æœ€é«˜ä½ä¸º0ï¼Œæ‰€ä»¥åˆå˜ä¸º0
ZFæ˜¯0æ ‡å¿—ä½ï¼Œè¿ç®—ç»“æœæœ€åä¸º0
AFè°ƒæ•´æ ‡å¿—ä½ï¼Œæœ€åå››ä½æœ‰è¿›ä½
PFå¥‡å¶ï¼Œæ²¡æœ‰1
CF æœ‰è¿›ä½
```

## æ¡ä»¶è·³è½¬

![image-20220223145429489](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220223145429489.png)

`cmp`æ¯”è¾ƒæŒ‡ä»¤ å’Œ`SUB`ç®€ç›´å·®ä¸å¤š

![image-20220223145755644](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220223145755644.png)

#  ä»1åŠ åˆ°100

`push dx` åœ¨8086å¤„ç†å™¨ä¸­ï¼Œå‹æ ˆå¿…é¡»æ˜¯16ä½ã€‚

`or r/m, r/m/imm`

![image-20220223194442447](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220223194442447.png)

ç¬¦å·ä½

`AND R/M , R/M/IMM`

# 13 8086çš„å¯»å€æ–¹å¼

> ä»…ä»…é’ˆå¯¹äº16ä½çš„8086å¤„ç†å™¨

- å¯„å­˜å™¨å¯»å€

- ç«‹å³æ•°å¯»å€

- ç›´æ¥(å†…å­˜)å¯»å€

- åŸºå€å¯»å€

  > æœ‰æ•ˆåœ°å€: åç§»åœ°å€

  `bp`: ä¸éœ€è¦ä½¿ç”¨æ ˆæ“ä½œå‰ç¼€,`SS`

  `bx`:é»˜è®¤ä½¿ç”¨å‰ç¼€`DS`

- å˜å€å¯»å€

  > ä½¿ç”¨ç´¢å¼•å¯„å­˜å™¨ SI DI

  ```
  ;ä½¿ç”¨å˜å€å¯»å€çš„ä¾‹å­
  mov [si],dx
  add ax,[di]
  xor word [si],0x8000 
  ```

15 ç¡¬ç›˜å’Œæ˜¾å¡çš„è®¿é—®ä¸æ§åˆ¶

![image-20220301230751409](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220301230751409.png)

```asciiarmor
SECTION data1  ALIGN=16 VSTART=0
```

`align`æŒ‡å®šæ®µçš„é•¿åº¦ `vstart`æŒ‡å®šæ®µçš„èµ·å§‹åœ°å€ï¼Œæ®µ

![image-20220301231238518](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220301231238518.png)

ç”¨æˆ·ç¨‹åº

![image-20220301234540253](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220301234540253.png)

è·å–æ®µçš„èµ·å§‹åœ°å€

![image-20220301234714885](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220301234714885.png)

ç”¨æˆ·ç¨‹åºæ®µçš„æ¨¡æ ·

![image-20220301235131915](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220301235131915.png)

```asciiarmor
app_lba_start equ 100
```

`equ`å£°æ˜ä¸€ä¸ªå¸¸æ•°ï¼Œå¸¸æ•°çš„å£°æ˜ä¸ä¼šå ç”¨æ±‡ç¼–åœ°å€

# 15 ç¡¬ç›˜å’Œæ˜¾å¡çš„è®¿é—®ä¸æ§åˆ¶

ç”¨æˆ·ç¨‹åºä»é€»è¾‘æ‰‡åŒº100å¼€å§‹å­˜æ”¾ã€‚åŠ è½½çš„åœ°å€å¿…é¡»æ˜¯`16å­—èŠ‚å¯¹é½`

- è¾“å…¥è¾“å‡ºç«¯å£çš„è®¿é—®

  ```
  in al, imm8
  in ax, imm8
  ```

  ```
  out dx/imm8, al/ax
  ```

- è¯»æ‰‡åŒºè®¾å¤‡

  >å—è®¾å¤‡
  >
  >- CHSè¯»å–
  >- LBAé€»è¾‘å—å¯»å€

![image-20220310235032006](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220310235032006.png)

å³è¾¹çš„å›¾ç‰‡æ˜¯æœ€é«˜ä½çš„æ‰‡åŒºå·ã€‚

ç°åœ¨å›è¿‡å¤´æ¥é‡æ–°å¯¹è¿™ä¸€å—ä»£ç è¿›è¡Œå®¡è§†:

```assembly
read_hard_disk_0:                           ;ä»ç¡¬ç›˜è¯»å–ä¸€ä¸ªé€»è¾‘æ‰‡åŒº
                                            ;EAX=é€»è¾‘æ‰‡åŒºå·
                                            ;DS:EBX=ç›®æ ‡ç¼“å†²åŒºåœ°å€
                                            ;è¿”å›ï¼šEBX=EBX+512
         push eax 
         push ecx
         push edx
      
         push eax
         
         mov dx,0x1f2
         mov al,1
         out dx,al                          ;è¯»å–çš„æ‰‡åŒºæ•°

         inc dx                             ;0x1f3
         pop eax
         out dx,al                          ;LBAåœ°å€7~0

         inc dx                             ;0x1f4
         mov cl,8
         shr eax,cl
         out dx,al                          ;LBAåœ°å€15~8

         inc dx                             ;0x1f5
         shr eax,cl
         out dx,al                          ;LBAåœ°å€23~16

         inc dx                             ;0x1f6
         shr eax,cl
         or al,0xe0                         ;ç¬¬ä¸€ç¡¬ç›˜  LBAåœ°å€27~24
         out dx,al

         inc dx                             ;0x1f7
         mov al,0x20                        ;è¯»å‘½ä»¤
         out dx,al

  .waits:
         in al,dx
         and al,0x88
         cmp al,0x08
         jnz .waits                         ;ä¸å¿™ï¼Œä¸”ç¡¬ç›˜å·²å‡†å¤‡å¥½æ•°æ®ä¼ è¾“ 

         mov ecx,256                        ;æ€»å…±è¦è¯»å–çš„å­—æ•°
         mov dx,0x1f0
  .readw:
         in ax,dx
         mov [ebx],ax
         add ebx,2
         loop .readw

         pop edx
         pop ecx
         pop eax
      
         retf                               ;æ®µé—´è¿”å›          
```

é¦–å…ˆæˆ‘ä»¬æŸ¥çœ‹ä¸Šé¢çš„éƒ¨åˆ†

```assembly
         push eax 
         push ecx
         push edx
      
         push eax
         ;ä¿å­˜è¿›å…¥è¿‡ç¨‹è°ƒç”¨å‰çš„å¯„å­˜å™¨çš„å€¼
         mov dx,0x1f2
         mov al,1
         out dx,al                          ;è¯»å–çš„æ‰‡åŒºæ•°

         inc dx                             ;0x1f3
         pop eax
         out dx,al                          ;LBAåœ°å€7~0

         inc dx                             ;0x1f4
         mov cl,8
         shr eax,cl
         out dx,al                          ;LBAåœ°å€15~8

         inc dx                             ;0x1f5
         shr eax,cl
         out dx,al                          ;LBAåœ°å€23~16

         inc dx                             ;0x1f6
         shr eax,cl
         or al,0xe0                         ;ç¬¬ä¸€ç¡¬ç›˜  LBAåœ°å€27~24
         out dx,al

         inc dx                             ;0x1f7
         mov al,0x20                        ;è¯»å‘½ä»¤
         out dx,al
```

è¿™é‡Œé¢å°±è¦è¯´åˆ°ç¡¬ç›˜çš„è¯»å–äº†ï¼Œæ˜¯æŒ‰ç…§æ‰‡åŒºæ¥è¿›è¡Œè¯»å–ã€‚ç«¯å£`0x1f2`é‡è¾“å…¥è¿›å»è¦è¯»å–å‡ ä¸ªæ‰‡åŒº,ç„¶åå°±å¼€å§‹ç»™äºˆ`LBA`åœ°å€äº†ï¼Œå› ä¸º`lba`åœ°å€æ˜¯28ä½çš„ï¼Œä½†æ˜¯åœ¨16ä½çš„æ¨¡å¼æ²¡æœ‰28ä½çš„å¯„å­˜å™¨ï¼Œæ‰€ä»¥

![image-20220318234415572](C:\Users\MSI\AppData\Roaming\Typora\typora-user-images\image-20220318234415572.png)

å°±æŒ‰ç…§ä¸‹é¢è¿™ç§æ–¹å¼è¿›è¡Œå­˜å‚¨ã€‚

- è¿‡ç¨‹è°ƒç”¨

- ç”¨æˆ·ç¨‹åºé‡å®šä½

- 14æ¯”ç‰¹ä½çš„ç§»åŠ¨æŒ‡ä»¤

  ```assembly
  calc_segment_base:                       ;è®¡ç®—16ä½æ®µåœ°å€
                                           ;è¾“å…¥ï¼šDX:AX=32ä½ç‰©ç†åœ°å€
                                           ;è¿”å›ï¼šAX=16ä½æ®µåŸºåœ°å€ 
           push dx                          
           
           add ax,[cs:phy_base]
           adc dx,[cs:phy_base+0x02]
           shr ax,4
           ror dx,4
           and dx,0xf000
           or ax,dx
           
           pop dx
           
           ret  
  ```

![image-20220315082212976](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220315082212976.png)

8086çš„å¤„ç†å™¨åªå…è®¸å¯»å€20ä½çš„åœ°å€ï¼Œæœ€å¤šåªå…è®¸å¯»å€1Må­—èŠ‚çš„å†…å­˜ã€‚è¿™ä¸ªç¨‹åºä¸åº”è¯¥ç ´ç¯ä»»ä½•å¯„å­˜å™¨çš„å†…å®¹ï¼Œé™¤äº†è¾“å‡ºçš„å¯„å­˜å™¨ã€‚

> åˆå› ä¸º8086å¤„ç†å™¨æ²¡æœ‰32ä½çš„å¯„å­˜å™¨ï¼Œä¸æ”¯æŒ32ä½çš„åŠ å‡æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½å¤Ÿä½¿ç”¨ä¸¤æ­¥çš„åŠ æ³•ã€‚`add ax,[cs:phy_base]` `adc dx,[cs:phy_base+0x02]`adcæŒ‡ä»¤æ˜¯å¸¦è¿›ä½çš„åŠ æ³•æŒ‡ä»¤ï¼Œä»–åœ¨è¿›è¡ŒåŠ æ³•çš„åŒæ—¶ï¼Œè¿˜ä¼šåŠ ä¸ŠCFçš„å€¼

`shr r/m, imm8` `shr r/m, cl` é€»è¾‘å³ç§»æŒ‡ä»¤ï¼Œæ ‡å¿—å¯„å­˜å™¨`CF`ç­‰äºæœ€åä¸€ä¸ªè¿›å…¥çš„ä½ç½®ã€‚`ror`åŒç†

![image-20220315083648958](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220315083648958.png)

![image-20220315084041175](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220315084041175.png)

`shl å’Œrol`

- è½¬åˆ°ç”¨æˆ·ç¨‹åº

  ![image-20220315085309815](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220315085309815.png)

- 8086çš„æ— æ¡ä»¶è½¬ç§»æŒ‡ä»¤

  - ç›¸å¯¹çŸ­è½¬ç§»å’Œ16ä½ç›¸å¯¹è¿‘è½¬ç§»

    `jmp short æ ‡å·/ç›®æ ‡å¤„çš„æ±‡ç¼–åœ°å€` -128~128

    `jmp near æ ‡å·/ç›®æ ‡å¤„çš„æ±‡ç¼–åœ°å€ `-32768~32767

    ä¸Šé¢è¿™ä¸¤ä¸ªåªèƒ½åœ¨å½“å‰çš„æ®µå†…è½¬ç§»

    `jmp æ ‡å·/ç›®æ ‡å¤„çš„æ±‡ç¼–åœ°å€`

    å¯èƒ½æ˜¯çŸ­è½¬ç§»ä¹Ÿæœ‰å¯èƒ½å°±æ˜¯è¿‘è½¬ç§»

  - 16ä½é—´æ¥ç»å¯¹è¿‘è½¬ç§»

    `jmp r/m` ä¹Ÿåªèƒ½åœ¨æ®µå†…

  - 16ä½ç›´æ¥ç»å¯¹è¿œè½¬ç§»

    jmp 16ä½æ®µåœ°å€:16ä½åç§»åœ°å€

      			|						|

    â€‹			CS						IP

  - 16ä½é—´æ¥ç»å¯¹è¿œè½¬ç§»

    `jmp far m`

    å¿…é¡»åœ¨må¤„æä¾›ä¸¤ä¸ªå€¼ï¼Œæ®µåœ°å€å’Œåç§»åœ°å€ï¼Œæ®µåœ°å€åœ¨å‰ï¼Œåç§»åœ°å€åœ¨å

- ç”¨æˆ·ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹

  `resb xx` å¼€æ”¾xxä¸ªå­—èŠ‚çš„å†…å­˜

  `resw`å’Œ`resd`ä¿å­˜å­—å’Œä¿å­˜åŒå­—

  > æ•°æ®æ˜¾ç¤ºçš„å°æŠ€å·§
  >
  >  db 'Hello World',0
  >
  > å½“æ˜¾ç¤ºHello Worldå­—ç¬¦çš„æ—¶å€™ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šå­—ç¬¦çš„é•¿åº¦ï¼Œæ‰€ä»¥å½“æ˜¾ç¤ºçš„æ—¶å€™ï¼Œæ£€æµ‹åˆ°0çš„æ—¶å€™å°±å¯ä»¥åˆ¤æ–­å·²ç»æ˜¾ç¤ºç»“æŸäº†ã€‚

  `ï¿¥`æ˜¯å½“å‰æ±‡ç¼–åœ°å€,`$$`æ˜¯ç¨‹åºå¼€å§‹çš„åœ°æ–¹ã€‚

  é™„ä¸Šç”¨æˆ·ç¨‹åºå¤´éƒ¨æ®µçš„ç¤ºæ„å›¾

  ![image-20220315151429140](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220315151429140.png)

- åŠ è½½å™¨çš„å·¥ä½œæµç¨‹

  > è¯»å–ç”¨æˆ·ç¨‹åºçš„èµ·å§‹æ‰‡åŒº
  >
  > æŠŠæ•´ä¸ªç”¨æˆ·ç¨‹åºéƒ½è¯»å…¥å†…å­˜
  >
  > è®¡ç®—æ®µçš„ç‰©ç†åœ°å€å’Œé€»è¾‘æ®µåœ°å€(æ®µçš„é‡å®šä½)
  >
  > è½¬ç§»åˆ°ç”¨æˆ·ç¨‹åºæ‰§è¡Œ(å°†å¤„ç†å™¨çš„æ§åˆ¶æƒäº¤ç»™ç”¨æˆ·ç¨‹åº)

- ä¹¦ä¸­ç”¨æˆ·ç¨‹åºæ¦‚è¿°

- ä¸æ–‡æœ¬æ˜¾ç¤ºæœ‰å…³çš„å›è½¦ æ¢è¡Œä¸å…‰æ ‡æ§åˆ¶

  ä¸¤ä¸ªå…‰æ ‡å¯„å­˜å™¨

  ```asm
  put_char:                                ;æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦
                                           ;è¾“å…¥ï¼šcl=å­—ç¬¦ascii
           push ax
           push bx
           push cx
           push dx
           push ds
           push es
  
           ;ä»¥ä¸‹å–å½“å‰å…‰æ ‡ä½ç½®
           mov dx,0x3d4
           mov al,0x0e
           out dx,al
           mov dx,0x3d5
           in al,dx                        ;é«˜8ä½ 
           mov ah,al
  
           mov dx,0x3d4
           mov al,0x0f
           out dx,al
           mov dx,0x3d5
           in al,dx                        ;ä½8ä½ 
           mov bx,ax                       ;BX=ä»£è¡¨å…‰æ ‡ä½ç½®çš„16ä½æ•°
  
           cmp cl,0x0d                     ;å›è½¦ç¬¦ï¼Ÿ
           jnz .put_0a                     ;ä¸æ˜¯ã€‚çœ‹çœ‹æ˜¯ä¸æ˜¯æ¢è¡Œç­‰å­—ç¬¦ 
           mov ax,bx                       ;æ­¤å¥ç•¥æ˜¾å¤šä½™ï¼Œä½†å»æ‰åè¿˜å¾—æ”¹ä¹¦ï¼Œéº»çƒ¦ 
           mov bl,80                       
           div bl
           mul bl
           mov bx,ax
           jmp .set_cursor
  
   .put_0a:
           cmp cl,0x0a                     ;æ¢è¡Œç¬¦ï¼Ÿ
           jnz .put_other                  ;ä¸æ˜¯ï¼Œé‚£å°±æ­£å¸¸æ˜¾ç¤ºå­—ç¬¦ 
           add bx,80
           jmp .roll_screen
  
   .put_other:                             ;æ­£å¸¸æ˜¾ç¤ºå­—ç¬¦
           mov ax,0xb800
           mov es,ax
           shl bx,1
           mov [es:bx],cl
  
           ;ä»¥ä¸‹å°†å…‰æ ‡ä½ç½®æ¨è¿›ä¸€ä¸ªå­—ç¬¦
           shr bx,1
           add bx,1
  
   .roll_screen:
           cmp bx,2000                     ;å…‰æ ‡è¶…å‡ºå±å¹•ï¼Ÿæ»šå±
           jl .set_cursor
  
           mov ax,0xb800
           mov ds,ax
           mov es,ax
           cld
           mov si,0xa0
           mov di,0x00
           mov cx,1920
           rep movsw
           mov bx,3840                     ;æ¸…é™¤å±å¹•æœ€åº•ä¸€è¡Œ
           mov cx,80
   .cls:
           mov word[es:bx],0x0720
           add bx,2
           loop .cls
  
           mov bx,1920
  
   .set_cursor:
           mov dx,0x3d4
           mov al,0x0e
           out dx,al
           mov dx,0x3d5
           mov al,bh
           out dx,al
           mov dx,0x3d4
           mov al,0x0f
           out dx,al
           mov dx,0x3d5
           mov al,bl
           out dx,al
  
           pop es
           pop ds
           pop dx
           pop cx
           pop bx
           pop ax
  
           ret
  ```

  ![image-20220315154939136](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220315154939136.png)

- å…‰æ ‡å¤„ç†

  `25è¡Œï¼Œä¸€è¡Œ80ä¸ªå­—ç¬¦`

  - mul r/m æ— ç¬¦å·æ­£æ•°çš„ç”Ÿå‘æŒ‡ä»¤

  > ä¹˜æ•°å¦‚æœæ˜¯8ä½çš„ ===ã€‹ AL
  >
  > ä¹˜æ•°å¦‚æœæ˜¯16ä½çš„===> AX
  >
  > ç›¸ä¹˜ä¹‹å ä¹˜ç§¯æ˜¯32ä½çš„ï¼Œä½16ä½åœ¨å¯„å­˜å™¨AXé‡Œé¢ é«˜16ä½åœ¨å¯„å­˜å™¨DXé‡Œ

  - 8086ä¸æ”¯æŒï¼Œä»80386å¼€å§‹æ”¯æŒ
  
  > è¢«ä¹˜æ•°æ˜¯32ä½çš„ï¼Œåœ¨å¯„å­˜å™¨EAXé‡Œ
  >
  > ä¹˜ç§¯æ˜¯64ä½çš„ï¼Œä½32ä½åœ¨å¯„å­˜å™¨EAXé‡Œé¢ï¼Œé«˜32ä½åœ¨å¯„å­˜å™¨EDXé‡Œé¢
  
  - imul æœ‰ç¬¦å·ä¹˜æ³•
  
- æ¢è¡Œå’Œæ™®é€šå­—ç¬¦çš„å¤„ç†è¿‡ç¨‹

  æ¢è¡Œ: åˆ—ä½ç½®ä¸å˜ è¡Œæ•°+1

- retf æŒ‡ä»¤è½¬åˆ°å¦å¤–ä¸€ä¸ªä»£ç æ®µæ‰§è¡Œ

  å¿…é¡»ä¿è¯æ ˆé¡¶çš„æ•°æ®æ˜¯è¦è¿”å›çš„åœ°å€å’Œä»£ç æ®µå¯„ä½ç½®
  
  
  
# 16 ä¸­æ–­å’ŒåŠ¨æ€æ—¶é’Ÿæ˜¾ç¤º

  `NMI`ğŸ†˜!

`intr `ä¸æ˜¯ç‰¹åˆ«ç´§æ€¥ï¼Œå¯ä»¥å±è”½

  `cli sti`

> cli: æ¸…æ¥šæ ‡å¿—ä½IF
>
> sti: è®¾ç½®æ ‡å¿—ä½IF

- ä¸­æ–­å‘é‡è¡¨

  ![image-20220316152457785](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220316152457785.png)

  ä¸€å…±æœ‰256ä¸ªä¸­æ–­ï¼Œ1KBå¤§å°

- ä¸­æ–­å¤„ç†è¿‡ç¨‹

  CPUè®¾ç½® ä¿®æ”¹æ ˆæ®µå¤„ç†çš„å¯„å­˜å™¨çš„æ—¶å€™ï¼Œç¦æ­¢å¤„ç†ä¸­æ–­

- RTCç”µè·¯å¯ä»¥å‘å‡ºçš„ä¸­æ–­ä¿¡

  1. å‘¨æœŸæ€§ä¸­æ–­ä¿¡å·(PF)

     ![image-20220316160049995](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220316160049995.png)

     å¯„å­˜å™¨A ï¼šæ§åˆ¶æ—¶åŸºé€‰æ‹©

     ![image-20220316160200592](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220316160200592.png)

     å¯„å­˜å™¨Bï¼šç¬¬6ä½æ§åˆ¶ï¼Œæ˜¯å¦å…è®¸å‘ç”Ÿå‘¨æœŸæ€§ä¸­æ–­

  2. æ›´æ–°å‘¨æœŸç»“æŸä¸­æ–­: æ£€æŸ¥æ•°æ®æ˜¯å¦è¶…å‡ºåŒºåŸŸæº¢å‡ºå’Œé—¹é’Ÿ

     å¯„å­˜å™¨Bçš„æœ€é«˜ä½: SETï¼š æ›´æ–°å‘¨æœŸé™æ­¢

     æ›´æ–°å‘¨æœŸç»“æŸä¸­æ–­å…è®¸: ç¬¬4ä½

     å¯„å­˜å™¨Açš„æœ€é«˜ä½: æ›´æ–°è¿‡ç¨‹æŒ‡ç¤ºï¼Œå¯¹å¯„å­˜å™¨Açš„å†™å…¥ä¸ä¼šæ”¹å˜è¿™ä¸€ä½ï¼Œä½†æ­¤ä½ä¸º1çš„æ—¶å€™è¡¨ç¤ºåœ¨ä¸€æ®µæ—¶é—´å†…æ›´æ–°å‘¨æœŸä¸ä¼šå‘ç”Ÿ

     æ›´æ–°å‘¨æœŸå‘ç”Ÿçš„æ—¶å€™: æ—¥æœŸå’Œæ—¶é—´çš„è®¿é—®å®é™…UIPä¸º0æ—¶ï¼Œå¯ä»¥è®¿é—®æ—¶é—´ä½

  3. é—¹é’Ÿä¸­æ–­

     å¯„å­˜å™¨Bçš„äº”ä½: é—¹é’Ÿä¸­æ–­å…è®¸
  
- å¯„å­˜å™¨Bå„ä½çš„å«ä¹‰

  ![image-20220316202608792](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220316202608792.png)

  è¯»å–è¿™ä¸ªå¯„å­˜å™¨æŒ‡ä»¤ä¹‹åï¼Œå›è‡ªåŠ¨æ¸…0

  ![image-20220316203457717](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220316203457717.png)

![image-20220316203608416](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220316203608416.png)

![image-20220316204419311](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220316204419311.png)

- TESTæŒ‡ä»¤

  åŠŸèƒ½ä¸ŠåŸºæœ¬å’ŒandæŒ‡ä»¤å·®ä¸å¤šï¼Œå€¼åªæ˜¯è¿ç®—ç»“æœè¢«ä¸¢å¼ƒ

```assembly
mov al,0x0c
out 0x70,al
in al,0x71
```

è¿™æ˜¯å¯¹äºRTCå¯„å­˜å™¨çš„è®¿é—®

- int æŒ‡ä»¤

  `int n` nçš„å–å€¼èŒƒå›´0~255,å› ä¸ºx86åªæœ‰256ç§ä¸­æ–­ 

  `int3`é™·é˜±ä¸­æ–­ è°ƒè¯•æŒ‡ä»¤ 

![image-20220316230925760](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220316230925760.png)

â€‹	`into`æº¢å‡ºä¸­æ–­æŒ‡ä»¤

![image-20220316231302972](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220316231302972.png)

- Biosï¼ˆä¸­æ–­åŠŸèƒ½ï¼‰è°ƒç”¨


# 17 32ä½X86å¤„ç†å™¨ç¼–ç¨‹æ¶æ„

- 32ä½å¤„ç†å™¨çš„å†…å­˜è®¿é—®æ¦‚å†µ

  æè¿°ç¬¦è¡¨: è®°å½•ä¸åŒçš„ç³»ç»Ÿæ®µ `æ®µå¯„å­˜å™¨`è¢«ç”¨æ¥è®°å½•æè¿°ç¬¦è¡¨çš„é€‰æ‹©å­

- 32ä½å¤„ç†å™¨çš„å¯»å€æ–¹å¼

  ![image-20220317091340517](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220317091340517.png)

# 18 ä¿æŠ¤æ¨¡å¼

- ä¿æŠ¤æ¨¡å¼

  å¤šç”¨æˆ· å¤šç¨‹åºè¿è¡Œçš„ã€‚

  ä¸€ä¸ªç¨‹åºæ˜¯ç”± ä»£ç æ®µ æ•°æ®æ®µ æ ˆç«¯

  æ¯ä¸ªç¨‹åºæœ‰ä¸åŒçš„ç‰¹æƒé›† : 0,1,2,3

- å…¨å±€æè¿°ç¬¦è¡¨å’Œå…¨å±€ç§’é€Ÿç¬¦è¡¨å¯„å­˜å™¨GDTR

  å®æ¨¡å¼:`å¼€å…¬å¸ä¸éœ€è¦ç™»è®°ï¼Œå–ä»€ä¹ˆä¹Ÿæ²¡æœ‰äººå…³ã€‚`

  ä¿æŠ¤æ¨¡å¼:`å¿…é¡»å…ˆç­‰çº§ï¼Œå½“ä½œçš„ä¹°å–å’Œæ³¨å†Œé¡¹ç›®ä¸ç¬¦æ—¶ï¼Œä¼šè¢«é˜»æ­¢`

- GDTR

  ![image-20220317144327162](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220317144327162.png)

`å…¨å±€æè¿°ç¬¦è¡¨è¾¹ç•Œ`=`è¡¨çš„å¤§å°`-1

`ä¸€ä¸ªæè¿°ç¬¦æ˜¯8ä¸ªå­—èŠ‚`

- æè¿°ç¬¦

  ![image-20220317145719769](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220317145719769.png)

  s=0:ç³»ç»Ÿæè¿°ç¬¦,TYPEæ¥æŒ‡å®šæ®µçš„ç±»å‹æˆ–è€…é—¨çš„ç±»å‹

  s=1:å­˜å‚¨å™¨çš„æ®µæè¿°ç¬¦,TYPEæ¥è¡¨ç¤ºæ•°æ®æ®µ è¿˜æ˜¯ä»£ç æ®µ

  ![image-20220317145937155](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220317145937155.png)

  ä¸‹é¢æ˜¯æ®µæè¿°ç¬¦çš„ä½32ä½ï¼Œä¸Šé¢æ˜¯æ®µæè¿°ç¬¦çš„é«˜32ä½

  é«˜32ä½çš„ç¬¬12ä½å°±æ˜¯ä¸Šé¢çš„sï¼ŒæŒ‡ç¤ºæ˜¯ç³»ç»Ÿè¿˜æ˜¯å­˜å‚¨å™¨æè¿°ç¬¦ï¼Œ11çš„`X`æ˜¯`execute`å•è¯çš„ç®€å†™ï¼Œæè¿°æ˜¯å¦å¯ä»¥æ‰§è¡Œã€‚`E`æ˜¯expand,ä¸º0ï¼Œå°±æ˜¯ä»ä½åœ°å€å‘é«˜åœ°å€æ‰©å±•çš„ï¼Œå°±æ˜¯æ™®é€šçš„æ•°æ®æ®µã€‚å¦‚æœæ˜¯1ï¼Œå°±æ˜¯ä»é«˜åœ°å€å‘ä½åœ°å€æ‰©å±•ï¼Œå°±æ˜¯æ ˆç«¯ã€‚`W`æŒ‡ç¤ºæ®µæ˜¯å¦å¯å†™ï¼Œ

  ![image-20220317150251956](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220317150251956.png)

  å¦‚æœæ˜¯`S=1ï¼ŒX=1`

  `DPL`ï¼šæŒ‡ç¤ºä»£ç æ®µçš„ç‰¹æƒçº§åˆ«ï¼Œä¸€å…±æœ‰4ç§,0,1,2,3

  `C`: 0: è¡¨ç¤ºå¿…é¡»è¦ç‰¹æƒçº§ç›¸åŒçš„ä»£ç æ‰èƒ½æ‰§è¡Œï¼Œ1:è¡¨ç¤ºä»£ç æ®µçº§åˆ«ä½çš„å¯ä»¥æ”¾è¿›æ¥æ‰§è¡Œ

  `R`: æ˜¯å¦å¯ä»¥åƒæ•°æ®æ®µä¸€æ ·è¯»å‡º

  `A`: æ˜¯å¦å·²ç»è®¿é—®é”…

- å­˜å‚¨å™¨æ®µæè¿°ç¬¦-æ®µç•Œé™ä»¥åŠæ®µè®¿é—®æ§åˆ¶ä½

  ![image-20220317150710854](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220317150710854.png)

  `æ®µç•Œé™`: 20ä½

  > å‘ä¸Šæ‰©å±•çš„æ®µ: æœ€å¤§çš„åœ°å€ æ®µç•Œé™+1
  >
  > å‘ä¸‹åœ°å€çš„æ®µ: FFFF- æ®µç•Œé™

  `G`: æ®µç•Œé™çš„å•ä½

  > 0: K
  >
  > 1: 4K
  >
  > å®é™…ä½¿ç”¨çš„æ®µåœ°å€=æ®µç•Œé™*0x1000+0xfff

  `P`:æ®µå­˜åœ¨ä½

  `L`:64ä½ä»£ç æ®µæ ‡å¿—

  `D/B`: 0 16ä½ 1 32ä½

  `AVL`: å¯ä»¥è‡ªç”±ä½¿ç”¨çš„ä¿ç•™ä½

  ```assembly
  mov dword [bx+0x08],0x8000ffff
  mov dword [bx+0x0c],0x0040920b 
  ```

  ![image-20220317153510427](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220317153510427.png)

- lgdt m

  `lgdt m48`:æ“ä½œæ•°å¿…é¡»æ˜¯48ä½

  8086å¤„ç†å™¨åªæœ‰20æ ¹åœ°å€çº¿
  
- å¼€å¯ç¬¬21æ ¹åœ°å€çº¿

  ![image-20220317154622009](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220317154622009.png)

  åœ°å€ç­‰ä»·çš„

- CR0å¯„å­˜å™¨

  æ§åˆ¶å¯„å­˜å™¨:0ä½æ˜¯PEä½,æ˜¯å¦å¯ç”¨ä¿æŠ¤æ¨¡å¼

  

  ![image-20220317160319622](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220317160319622.png)
  
- æ®µé€‰æ‹©å­å’Œæ®µé€‰æ‹©å™¨

  ![image-20220317200634871](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220317200634871.png)

`TI`:æŒ‡å®šæ®µæè¿°ç¬¦çš„ä½ç½®

![image-20220317201323960](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220317201323960.png)

æ“ä½œç³»ç»Ÿè¯¾ç¨‹å·²ç»å­¦è¿‡ä¸ç”¨å¤šè¯´ã€‚è¿™é‡Œçš„ä¹˜ä»¥8ï¼Œæ˜¯æè¿°ç¬¦çš„`ç´¢å¼•å·*8`,å°±æ˜¯å»æ‰`TL`å’Œ`RPL(Qè¯·æ±‚ç‰¹æƒé›†)`

# 19 æŒ‡ä»¤çš„æ ¼å¼

- ModR/Må­—æ®µ

  ![image-20220318083255395](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220318083255395.png)

  ä¸­é—´çš„3-5å­—æ®µæ˜¯é€‰æ‹©ï¼Œè¦ä¹ˆæ˜¯å¯„å­˜å™¨éƒ¨åˆ†ï¼Œè¦ä¹ˆæ˜¯`opcode`ã€‚

  ![image-20220318083802286](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220318083802286.png)

  ä¸¾ä¸ª`æ —å­`,åœ¨è¿™é‡Œçš„`/r`æ˜¯çº¯å¯„å­˜å™¨çš„æ„æ€ï¼Œåœ¨è¿™é‡Œå°±æ˜¯å³æ“ä½œæ•°ï¼Œæˆ‘ä»¬å°±éœ€è¦æŠŠè¿™ä¸ªçº¯å¯„å­˜å™¨ç»™è¡¥å……åˆ°ModR/Må­—æ®µçš„3-5ä½ã€‚å¦‚æœæ˜¯`/num`å°±æ˜¯éœ€è¦æŠŠè¿™ä¸ªæ•°å­—è½¬æ¢ä¸º3ä½çš„äºŒè¿›åˆ¶å¹¶ä¸”å¡«å……åˆ°3-5ä½`[--][--]`è¡¨ç¤ºåé¢æœ‰SIBéƒ¨åˆ†

- ç»ƒä¹ 

  ![image-20220318090934769](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220318090934769.png)





![image-20220318090947718](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220318090947718.png)





![image-20220318090958315](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220318090958315.png)



- æŒ‡ä»¤å‰ç¼€

  ![image-20220318091023355](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220318091023355.png)



 `jmp`æŒ‡ä»¤æ‰§è¡Œåï¼Œæµæ°´çº¿ä¼šè¢«æ¸…ç©ºã€‚

# 20 å­˜å‚¨å™¨çš„ä¿æŠ¤

- ä¿®æ”¹æ®µå¯„å­˜å™¨æ—¶çš„ä¿æŠ¤

  ![image-20220318110148487](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220318110148487.png)

- ç”¨å‘ä¸Šæ‰©å±•çš„æ®µä½œä¸ºæ ˆæ®µ

  `æ®µçš„æ‰©å±•æ–¹å‘`å’Œ`æ ˆçš„æ¨è¿›æ–¹å‘`ä¸æ˜¯ä¸€å›äº‹

  æ ˆçš„æ‰©å±•æ–¹å‘: åªæ˜¯å»çœ‹å¦‚ä½•å»æ£€æŸ¥ä»–çš„èŒƒå›´ã€‚

  æ ˆçš„æ¨è¿›æ–¹å‘å§‹ç»ˆæ˜¯å‘ä¸‹çš„ã€‚

  ![image-20220318111559618](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220318111559618.png)

  æ•°æ®æ®µçš„`B`ä½æ˜¯ç”¨æ¥æŒ‡å®šï¼Œæ ˆé¡¶æŒ‡é’ˆæ˜¯ä½¿ç”¨`ESP`è¿˜æ˜¯`SP`

- å†…å­˜çº¿æ€§åœ°å€çš„å›ç»•ç‰¹æ€§

  ![image-20220318195719290](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220318195719290.png)

  

  è¿™ä¸ªå†…å­˜ç©ºé—´çš„åˆ†å¸ƒåŸºåœ°å€æ˜¯`20000000`

- å‘ä¸‹æ‰©å±•çš„æ®µä½œä¸ºæ ˆæ®µ

   ![image-20220318200028318](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220318200028318.png)

# 21 ä¿æŠ¤æ¨¡å¼ç¨‹åºçš„åŠ¨æ€åŠ è½½å’Œæ‰§è¡Œ

- æ¦‚è¦

  ![image-20220318203803313](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220318203803313.png)
  
- `bswap r`

  å­—èŠ‚ç¿»è½¬

- ç°æœ‰çš„å†…æ ¸å¸ƒå±€

  ![image-20220319085547767](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220319085547767.png)

-   `CPUID`è·å–å¤„ç†å™¨å“ç‰Œä¿¡æ¯

  `EAX`ï¼š æŒ‡å®šåŠŸèƒ½å·

  ![image-20220319092137142](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220319092137142.png)

- æ¡ä»¶ä¼ é€æŒ‡ä»¤ç°‡`cmov cc` r,r/m

  `cc`æ˜¯åç¼€ï¼ŒæŒ‡å®šæƒ…å†µã€‚

  ä¸¾ä¸ªæ —å­

  ```assembly
   ;è‹¥eaxå’Œadxçš„å€¼ä¸åŒï¼Œåˆ™å°†edxçš„å€¼ä¼ é€åˆ°eax
   cmp eax,edx
   cmovne eax,edx
  ```

- `sgdt m`

  `sgdt [pgdt]`å°†gdtçš„å†…å®¹å­˜å‚¨åˆ°å†…å­˜pgdtçš„ä½ç½®

- `movzx`

  ![image-20220319103637748](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220319103637748.png)

  å¸¦0ä¼ é€æŒ‡ä»¤ï¼Œ0æ‰©å±•çš„æ“ä½œæŒ‡ä»¤

# ç”¨æˆ·ç¨‹åºä¸å†…æ ¸ä¹‹é—´çš„åˆ‡æ¢

> ç”¨æˆ·ç¨‹åºä¸åº”è¯¥ä¸ºå†…æ ¸æä¾›æ”¯æ’‘ 
>
> å¸¸é‡å®šä¹‰ä¸å æ®å­˜å‚¨ç©ºé—´

- ä¸²æ¯”è¾ƒæŒ‡ä»¤

  `CMPS`: 

  ```
  cmpsb
  cmpsw
  cmpsd
  cmpsq
  ```

  ![image-20220321111524580](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321111524580.png)

![image-20220321111806929](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321111806929.png)

![image-20220321112053258](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321112053258.png)

![image-20220321112236589](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321112236589.png)

![image-20220321112613303](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321112613303.png)

- ç®€æ˜“å†…æ ¸å’Œç”¨æˆ·ç¨‹åºæ®µçš„ç¤ºæ„å›¾

  ![image-20220321143016553](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321143016553.png)

> EDI:æŒ‡å‘ç”¨æˆ·ç¨‹åºå¤´éƒ¨ä¸­çš„
>
> ESï¼š ç”¨æˆ·ç¨‹åºå¤´éƒ¨åŸºåœ°å€
>
> ESI: å†…æ ¸ç¨‹åºsalt
>
> DSï¼š å†…æ ¸æ•°æ®æ®µåŸºåœ°å€

![image-20220321143600200](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321143600200.png)

æ–°çš„å†…æ ¸ä¸­ä½¿ç”¨`jmp far`æ¥å°†è¿è¡Œæ§åˆ¶æƒäº¤åˆ°ç”¨æˆ·ç¨‹åºä¸­ï¼Œå°±ä¸ä¼šå‡ºæ ˆçš„åˆ‡æ¢é—®é¢˜

- PUSHAD POPAD XLAT

  ```
  put_hex
  ```

- xlat

  ![image-20220321145017544](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321145017544.png)

# ä»»åŠ¡å’Œä»»åŠ¡çš„åˆ›å»º

> å‹æ ˆå’Œå‡ºæ ˆå¿…é¡»è¦å¹³è¡¡

- `POP CS`æ˜¯éæ³•çš„

  å‹æ ˆçš„æ—¶å€™: æ®µå¯„å­˜å™¨å’Œç«‹å³æ•°æ˜¯å¾ˆç‰¹æ®Šçš„.ä¸»è¦é æ­¤æ—¶cpuçš„é»˜è®¤æ“ä½œå°ºå¯¸

- BPæˆ–è€…EBPä½œä¸ºæœ‰æ•ˆåœ°å€

  é»˜è®¤ä½¿ç”¨`SS`åšä¸ºæ®µå¯„å­˜å™¨ã€‚

- LDTå’ŒGDT

  GDTä¸­çš„0å·æ§½ä½æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥ä¸å­˜åœ¨é€‰æ‹©å­æ˜¯0çš„æè¿°ç¬¦ï¼Œä½†æ˜¯LDTä¹Ÿå°±æ˜¯æ®µæè¿°ç¬¦çš„ç¬¬TIä½ä½1çš„ï¼Œä»»ä½•æ—¶å€™éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚

- GDT TSS LDT

  ![image-20220321205352424](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321205352424.png)

![image-20220321205625835](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321205625835.png)

- TSSæè¿°ç¬¦

  ![image-20220321210531145](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321210531145.png)

- å½“å‰å†…å­˜å¸ƒå±€

  ![image-20220321211539107](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321211539107.png)

![image-20220321211549684](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321211549684.png)

- ltr lldt

  ![image-20220321211856136](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321211856136.png)

  åœ¨åœ°å€å¤„å¿…é¡»æ˜¯TRæˆ–è€…LDTçš„é€‰æ‹©å­

  ![image-20220321212026937](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220321212026937.png)

  å·¥ä½œæµç¨‹

# ç‰¹æƒçº§ä¿æŠ¤

- ç‰¹æƒçº§

  ```
  0 æ“ä½œç³»ç»Ÿæ ¸å¿ƒ
  1 ç³»ç»ŸæœåŠ¡ç¨‹åº
  2 åŒä¸Š
  3 ç”¨æˆ·ç¨‹åº
  ```

  å®æ¨¡å¼ä¸‹å¾—ç¨‹åºéƒ½æ˜¯`0`ç‰¹æƒçº§

- æ³¨æ„

  å¯ä»¥ä»ä½ç‰¹æƒçº§ä»£ç æ®µè½¬ç§»åˆ°é«˜ç‰¹æƒçº§ï¼Œä½†æ˜¯ä¸èƒ½ä»é«˜ç‰¹æƒçº§ä»£ç æ®µè½¬ç§»åˆ°ä½

- å¦‚ä½•ä»é«˜åˆ°ä½ï¼Ÿ

  - å°†ä»£ç æ®µè®¾ç½®ä½ä¾ä»å¾—ä»£ç æ®µ
  - é—¨æè¿°ç¬¦

- è°ƒç”¨é—¨

  ä»ä½ç‰¹æƒçº§åˆ°é«˜ç‰¹æƒçº§

  ![image-20220322202904807](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220322202904807.png)

![image-20220322203022298](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220322203022298.png)

- ç‰¹æƒçº§æ£€æŸ¥çš„æ—¶é—´

  1. æ‰§è¡Œç‰¹æƒæŒ‡ä»¤ ltr lldt
  2. ä¿®æ”¹æ®µå¯„å­˜å™¨
  
- è¯·æ±‚ç‰¹æƒçº§

  ![image-20220322205511497](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220322205511497.png)

  å½“æ®µé€‰æ‹©å­è¿›å…¥æ•°æ®æ®µå¯„å­˜å™¨çš„æ—¶å€™ï¼ŒCPUéœ€è¦æ£€æŸ¥

  1. CPL<= DPL
  2. RPL<=DPL

- ARPL è¯·æ±‚ç‰¹æƒçº§è°ƒæ•´æŒ‡ä»¤

- æ ˆæ®µçš„ç‰¹æƒçº§å¿…é¡»è¦å’ŒCPLç›¸åŒ

- è°ƒç”¨é—¨çš„æµ‹è¯•å’Œè°ƒç”¨ä»¬è½¬ç§»

  > 1. é€šè¿‡è°ƒç”¨é—¨é€‰æ‹©å­æ¥è¿›è¡Œè½¬ç§»çš„æ—¶å€™ï¼Œé€‰æ‹©å­å‰çš„åç§»é‡ä¼šè¢«å¿½ç•¥

  ```assembly
  ;åœ¨GDTä¸­ç™»è®°LDTæè¿°ç¬¦
           mov eax,[es:esi+0x0c]              ;LDTçš„èµ·å§‹çº¿æ€§åœ°å€
           movzx ebx,word [es:esi+0x0a]       ;LDTæ®µç•Œé™
           mov ecx,0x00408200                 ;LDTæè¿°ç¬¦ï¼Œç‰¹æƒçº§0
           call sys_routine_seg_sel:make_seg_descriptor
           call sys_routine_seg_sel:set_up_gdt_descriptor
           mov [es:esi+0x10],cx               ;ç™»è®°LDTé€‰æ‹©å­åˆ°TCBä¸­
         
           ;åˆ›å»ºç”¨æˆ·ç¨‹åºçš„TSS
           mov ecx,104                        ;tssçš„åŸºæœ¬å°ºå¯¸
           mov [es:esi+0x12],cx              
           dec word [es:esi+0x12]             ;ç™»è®°TSSç•Œé™å€¼åˆ°TCB 
           call sys_routine_seg_sel:allocate_memory
           mov [es:esi+0x14],ecx              ;ç™»è®°TSSåŸºåœ°å€åˆ°TCB
        
           ;ç™»è®°åŸºæœ¬çš„TSSè¡¨æ ¼å†…å®¹
           mov word [es:ecx+0],0              ;åå‘é“¾=0
        
           mov edx,[es:esi+0x24]              ;ç™»è®°0ç‰¹æƒçº§å †æ ˆåˆå§‹ESP
           mov [es:ecx+4],edx                 ;åˆ°TSSä¸­
        
           mov dx,[es:esi+0x22]               ;ç™»è®°0ç‰¹æƒçº§å †æ ˆæ®µé€‰æ‹©å­
           mov [es:ecx+8],dx                  ;åˆ°TSSä¸­
        
           mov edx,[es:esi+0x32]              ;ç™»è®°1ç‰¹æƒçº§å †æ ˆåˆå§‹ESP
           mov [es:ecx+12],edx                ;åˆ°TSSä¸­
  
           mov dx,[es:esi+0x30]               ;ç™»è®°1ç‰¹æƒçº§å †æ ˆæ®µé€‰æ‹©å­
           mov [es:ecx+16],dx                 ;åˆ°TSSä¸­
  
           mov edx,[es:esi+0x40]              ;ç™»è®°2ç‰¹æƒçº§å †æ ˆåˆå§‹ESP
           mov [es:ecx+20],edx                ;åˆ°TSSä¸­
  
           mov dx,[es:esi+0x3e]               ;ç™»è®°2ç‰¹æƒçº§å †æ ˆæ®µé€‰æ‹©å­
           mov [es:ecx+24],dx                 ;åˆ°TSSä¸­
  
           mov dx,[es:esi+0x10]               ;ç™»è®°ä»»åŠ¡çš„LDTé€‰æ‹©å­
           mov [es:ecx+96],dx                 ;åˆ°TSSä¸­
        
           mov dx,[es:esi+0x12]               ;ç™»è®°ä»»åŠ¡çš„I/Oä½å›¾åç§»
           mov [es:ecx+102],dx                ;åˆ°TSSä¸­ 
        
           mov word [es:ecx+100],0            ;T=0
         
           ;åœ¨GDTä¸­ç™»è®°TSSæè¿°ç¬¦ 
  ```

  retf: ä¸ä¼šæ£€æŸ¥ç‰¹æƒçº§åˆ«

  ![image-20220323090224572](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220323090224572.png)

# å¤šä»»åŠ¡

- ä¸¤ç§åŸºæœ¬çš„ä»»åŠ¡åˆ‡æ¢æ–¹å¼

  ååŒå¼ä»»åŠ¡åˆ‡æ¢

  æŠ¢å å¼ä»»åŠ¡åˆ‡æ¢

- `pushf/pushfd`å’Œ`popf/popfd`

  pushf/pushfd: åœ¨ä»»ä½•ç‰¹æƒçº§éƒ½å¯ä»¥ä½¿ç”¨

  popf/pofdï¼šå¹¶ä¸æ˜¯ç‰¹æƒçº§æŒ‡ä»¤ï¼Œåªæ˜¯æœ‰ä¸€äº›æ ‡å¿—ä½å¿…é¡»0ç‰¹æƒ

- I/Oè®¸å¯ä½ä¸²

  ![image-20220323103847192](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220323103847192.png)

  I/Oè®¸å¯ä½åŒºåŸŸåœ¨TSSä¸­ï¼Œåœ¨TSSå¤„102åç§»å¤„å­˜æ”¾çš„æ˜¯I/Oè®¸å¯æ˜ å°„åŒºçš„ä½ç½®ã€‚

  ![image-20220323104217026](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220323104217026.png)

  å¦‚æœI/Oæ˜ å°„åŸºåœ°å€æ˜¯0ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¿™ä¸ªç¨‹åºä¸èƒ½è®¿é—®ä»»ä½•çš„ç«¯å£ã€‚ä¸ºäº†é¿å…ç«¯å£çš„æœ€åè¶Šç•Œï¼Œæ‰€ä»¥TSSçš„I/Oæœ€åçš„ä¸€ä¸ªå­—èŠ‚å¿…é¡»æ˜¯`FF`

- ä»»åŠ¡åˆ‡æ¢æ–¹æ³•

  - ç¡¬ä»¶ä»»åŠ¡åˆ‡æ¢
  - ç¨‹åºå‘˜è‡ªè¡Œåˆ‡æ¢

- ç”¨æˆ·ä»»åŠ¡çš„åˆ›å»ºå’Œåˆå§‹åŒ–

  ```assembly
           mov ecx,0x46
           call sys_routine_seg_sel:allocate_memory
           mov word [es:ecx+0x04],0            ;ä»»åŠ¡çŠ¶æ€:å°±ç»ª
           call append_to_tcb_link 
  ```

  ä»»åŠ¡çŠ¶æ€å¦‚æœæ˜¯`ffff`:è¡¨æ˜æ­£åœ¨è¿è¡Œï¼Œ`3333`:è¡¨æ˜å·²ç»ç»ˆæ­¢,`0`:è¡¨æ˜å°±ç»ª

- ç®€å•çš„ä»»åŠ¡è°ƒåº¦å’Œåˆ‡æ¢

  ä»»ä½•ä»»åŠ¡éƒ½æ˜¯å¹³ç­‰çš„åŠ å…¥ä»»åŠ¡è°ƒåº¦çš„ï¼Œåªæ˜¯ä¸åŒçš„ä»»åŠ¡æ‰€ä½œçš„å·¥ä½œä¸ä¸€æ ·ã€‚

# ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†ï¼ŒååŒä»»åŠ¡åˆ‡æ¢

- ååŒå¼ä»»åŠ¡åˆ‡æ¢

  > bug: å¦‚æœä¸€ä¸ªç”¨æˆ·ç¨‹åºä¸ä½¿ç”¨å†…æ ¸ç¨‹åºï¼Œé‚£ä¹ˆå°±ä¸èƒ½äº§ç”Ÿä»»åŠ¡çš„åˆ‡æ¢

- ä¸­æ–­å’Œå¼‚å¸¸

  å¼‚å¸¸çš„åˆ†ç±»: `æŒ‡ä»¤æ‰§è¡Œå¼‚å¸¸`,`ç¨‹åºè°ƒè¯•å¼‚å¸¸`,`æœºå™¨æ£€æŸ¥å¼‚å¸¸`

  å¼‚å¸¸æ ¹æ®ä¸¥é‡æ€§åˆ†ç±»:`æ•…éšœ`,`é™·é˜±`,`ç»ˆæ­¢`

- ä¸­æ–­æè¿°ç¬¦è¡¨ã€ä¸­æ–­é—¨å’Œé™·é˜±é—¨

  256ä¸ªä¸­æ–­ï¼Œ1kbå¤§å°ï¼Œä»0å¼€å§‹ï¼Œæ¯ä¸€ä¸ªå…¥å£åœ°å€åŒ…æ‹¬:`æ®µåœ°å€+åç§»åœ°å€`

  ä¸­æ–­é—¨çš„æ ¼å¼:

  ![image-20220324150947421](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220324150947421.png)

  é™·é˜±é—¨çš„æ ¼å¼

  ![image-20220324151139846](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220324151139846.png)

  ä¸­æ–­é—¨å’Œå¼‚å¸¸é—¨åªèƒ½æ”¾åœ¨`IDT`ä¸­

  `IDTR`:32ä½åŸºåœ°å€+16ä½çš„è¡¨ç•Œé™

- 8209açš„åˆå§‹åŒ–æ–¹å¼

  åˆå§‹åŒ–çš„å‘½ä»¤å­—

  ![image-20220324162240913](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220324162240913.png)

  ![image-20220324162250419](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220324162250419.png)

  ![image-20220324162258578](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220324162258578.png)

![image-20220324162336194](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220324162336194.png)

- ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†æ—¶çš„ç‰¹æƒçº§ä¿æŠ¤

  1. ä¸æ£€æŸ¥RPLä¿æŠ¤
  2. ä¸æ£€æŸ¥é—¨çš„DPL é™¤äº†int n,int3,into
  3. CPL>= ç›®æ ‡ä»£ç æ®µçš„DPL

- æ³¨æ„

  é€šè¿‡`iret`å’Œ`iretd`æŒ‡ä»¤ä»ä¸­æ–­å¤„ç†è¿‡ç¨‹è¿”å›æ—¶ï¼Œå¤„ç†å™¨ä¸ä¼šè‡ªåŠ¨ä»æ ˆä¸­å¼¹å‡ºé”™è¯¯ä»£ç ï¼Œéœ€è¦è‡ªå·±å¼¹å‡º

- åœ¨ä¸­æ–­å¤„ç†è¿‡ç¨‹ä¸­å®æ–½ä»»åŠ¡åˆ‡æ¢ï¼ˆNOPï¼‰

  `NOP`:æ— æ“ä½œï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ



# åˆ†é¡µæœºåˆ¶å’ŒåŠ¨æ€é¡µé¢åˆ†é…

- é¡µè¡¨é¡¹å’Œé¡µç›®å½•é¡¹

  ![image-20220324202559730](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220324202559730.png)

![image-20220324202612964](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220324202612964.png)

```
p å­˜åœ¨ä½ 1 ä½äºå†…å­˜ä¸­ 
R/W è¯»å†™ä½ 0 åªèƒ½è¯»å– 1 å¯è¯»å¯å†™
US ç”¨æˆ·/ç®¡ç†ä½	1 ä»»ä½•ç‰¹æƒçº§éƒ½å¯ä»¥è®¿é—®	0 åªå…è®¸0ï¼Œ1ï¼Œ2ç‰¹æƒçº§è®¿é—®
PWT é¡µçº§é€šæ€ä½	é«˜é€Ÿç¼“å­˜
PCD é¡µçº§å‘Šè¯‰ç¼“å­˜ç¦æ­¢ä½
A	è®¿é—®ä½		æŒ‡ç¤ºæ˜¯å¦è¢«è®¿é—®è¿‡
D	æ˜¯å¦å†™è¿‡æ•°æ®
PAT	 
G å…¨å±€ä½ 
AVL è¢«å¤„ç†å™¨å¿½ç•¥ è½¯ä»¶å¯ä»¥ä½¿ç”¨
```

- CR3æ§åˆ¶å¯„å­˜å™¨

  ![image-20220324203920247](https://gitee.com/Cralwer/typora-pic/raw/master/images/image-20220324203920247.png)

  `cr0`çš„æœ€é«˜ä½æ—¶é¡µåŠŸèƒ½å¼€å¯çš„æ ‡å¿—ä½

- ä»»åŠ¡å…¨å±€ç©ºé—´å’Œå±€éƒ¨ç©ºé—´

  å†…æ ¸æ˜¯æ‰€æœ‰ä»»åŠ¡å…¬ç”¨çš„ï¼Œå®ƒåº”è¯¥å±äºæ¯ä¸ªä»»åŠ¡çš„å…¨å±€ç©ºé—´

- ä»»åŠ¡è¡¨é¡¹è½¬æ¢

  å¦‚æœé¡µç›®å½•è¡¨çš„æœ€åä¸€ä¸ªç›®å½•é¡¹æŒ‡å‘å½“å‰ç›®å½•è¡¨è‡ªå·±ï¼Œé‚£ä¹ˆï¼Œæ— è®ºæ—¶å€™ï¼Œå½“çº¿æ€§åœ°å€çš„é«˜20ä½æ˜¯FFFFFï¼Œè®¿é—®çš„å°±æ˜¯é¡µç›®å½•è¡¨è‡ªå·±

- `bts`æŒ‡ä»¤

  æµ‹è¯•ä½ä¸²ä¸­çš„æŸæ¯”ç‰¹ï¼Œç”¨è¯¥æ¯”ç‰¹çš„å€¼æ¥è®¾ç½®EFLAGSå¯„å­˜å™¨çš„CFæ ‡å¿—ï¼Œç„¶åå°†è¯¥æ¯”ç‰¹è®¾ç½®"1".

  ```assembly
  bts r/m16,r16
  bts r/m32,r32
  ```

  åŒæ ·çš„æŒ‡ä»¤è¿˜æœ‰`btr`,`btc`,`bt`

- è®¿é—®è¦è¢«ä¿®æ”¹çš„é¡µè¡¨é¡¹

  ```assembly
    .b1:
           ;å¼€å§‹è®¿é—®è¯¥çº¿æ€§åœ°å€æ‰€å¯¹åº”çš„é¡µè¡¨ 
           mov esi,ebx
           shr esi,10
           and esi,0x003ff000                 ;æˆ–è€…0xfffff000ï¼Œå› é«˜10ä½æ˜¯é›¶ 
           or esi,0xffc00000                  ;å¾—åˆ°è¯¥é¡µè¡¨çš„çº¿æ€§åœ°å€
           ;å¾—åˆ°è¯¥çº¿æ€§åœ°å€åœ¨é¡µè¡¨å†…çš„å¯¹åº”æ¡ç›®ï¼ˆé¡µè¡¨é¡¹ï¼‰ 
           and ebx,0x003ff000
           shr ebx,10                         ;ç›¸å½“äºå³ç§»12ä½ï¼Œå†ä¹˜ä»¥4
           or esi,ebx                         ;é¡µè¡¨é¡¹çš„çº¿æ€§åœ°å€ 
  ```

# Ending

> Come to An Happy Ending
